/*!
 * videojs-hlsjs-live-record
 * Live stream record functionality for VideoJS with hls.js
 * 
 * @version v0.1.2
 * @author [object Object]
 * @homepage https://github.com/TTitanUA/videojs-hlsjs-live-record#readme
 * @repository https://github.com/TTitanUA/videojs-hlsjs-live-record.git
 */
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("videojs")):"function"==typeof define&&define.amd?define("videojs-hlsjs-live-record",["videojs"],t):"object"==typeof exports?exports["videojs-hlsjs-live-record"]=t(require("videojs")):e["videojs-hlsjs-live-record"]=t(e.videojs)}("undefined"!=typeof self?self:this,(function(e){return function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=14)}([function(t,n){t.exports=e},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.exports=function(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}},function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(e,t,n){var o=n(13);function r(t,n,i){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=r=Reflect.get:e.exports=r=function(e,t,n){var r=o(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}},r(t,n,i||t)}e.exports=r},function(e,t,n){var o=n(9),r=n(8);e.exports=function(e,t){return!t||"object"!==o(t)&&"function"!=typeof t?r(e):t}},function(e,t,n){var o=n(11);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t){function n(t){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=n=function(e){return typeof e}:e.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(t)}e.exports=n},function(e){e.exports=JSON.parse('{"a":"0.1.2"}')},function(e,t){function n(t,o){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,o)}e.exports=n},function(e,t,n){},function(e,t,n){var o=n(1);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=o(e)););return e}},function(e,t,n){"use strict";n.r(t);var o=n(2),r=n.n(o),i=n(3),s=n.n(i),l=n(6),a=n.n(l),c=n(1),u=n.n(c),d=n(8),h=n.n(d),p=n(7),f=n.n(p),v=n(4),m=n.n(v),g=(n(12),n(0)),y=n.n(g),C=n(10),b=y.a.getComponent("ProgressControl"),j=(y.a.dom,function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,n))}return f()(t,e),t}(b)),w=n(5),k=n.n(w),R=y.a.getComponent("Button"),E=(y.a.dom,{}),S=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,Object.assign(E,n)))}return f()(t,e),s()(t,[{key:"createEl",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.nonIconControl=!0,n=Object.assign({className:"vjs-control vjs-seek-to-live-control vjs-at-live-edge",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span>LIVE'},n),o=Object.assign({"aria-live":"off"},o),k()(u()(t.prototype),"createEl",this).call(this,e,n,o)}},{key:"createControlTextEl",value:function(e){this.controlText_="Stream Type",k()(u()(t.prototype),"createControlTextEl",this).call(this,e)}},{key:"handleClick",value:function(e){this.options_.clickHandler&&this.options_.clickHandler.call(this,arguments)}}]),t}(R),T=y.a.getComponent("Button"),O=(y.a.dom,{}),x=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,Object.assign(O,n)))}return f()(t,e),s()(t,[{key:"createEl",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.nonIconControl=!0,n=Object.assign({className:"vjs-seek-to-live-control",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span>LIVE'},n),o=Object.assign({"aria-live":"On"},o),k()(u()(t.prototype),"createEl",this).call(this,e,n,o)}},{key:"createControlTextEl",value:function(e){this.controlText_="Stream Type",k()(u()(t.prototype),"createControlTextEl",this).call(this,e)}},{key:"handleClick",value:function(e){this.options_.clickHandler&&this.options_.clickHandler.call(this,arguments)}}]),t}(T),H=y.a.getComponent("Button"),L=(y.a.dom,{}),P=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,Object.assign(L,n)))}return f()(t,e),s()(t,[{key:"createEl",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.nonIconControl=!0,n=Object.assign({className:"vjs-control vjs-seek-to-live-control",innerHTML:'<span aria-hidden="true" class="vjs-icon-placeholder"></span>REC'},n),o=Object.assign({"aria-live":"On"},o),k()(u()(t.prototype),"createEl",this).call(this,e,n,o)}},{key:"createControlTextEl",value:function(e){this.controlText_="Start Record",k()(u()(t.prototype),"createControlTextEl",this).call(this,e)}},{key:"handleClick",value:function(e){this.options_.clickHandler&&this.options_.clickHandler.call(this,arguments)}}]),t}(H),_=y.a.getComponent("Button"),B=(y.a.dom,{}),M=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,Object.assign(B,n)))}return f()(t,e),s()(t,[{key:"createEl",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.nonIconControl=!1,n=Object.assign({className:"vjs-control vjs-hlsjs-lr-stop",innerHTML:'<i class="material-icons">stop</i>'},n),k()(u()(t.prototype),"createEl",this).call(this,e,n,o)}},{key:"createControlTextEl",value:function(e){this.controlText_="Stop Record",k()(u()(t.prototype),"createControlTextEl",this).call(this,e)}},{key:"handleClick",value:function(e){this.options_.clickHandler&&this.options_.clickHandler.call(this,arguments)}}]),t}(_),N=function(e,t){e=e<0?0:e;var n=Math.floor(e%60),o=Math.floor(e/60%60),r=Math.floor(e/3600),i=Math.floor(t/60%60),s=Math.floor(t/3600);return(isNaN(e)||e===1/0)&&(r=o=n="-"),(r=r>0||s>0?r+":":"")+(o=((r||i>=10)&&o<10?"0"+o:o)+":")+(n=n<10?"0"+n:n)},D=N;var I=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;return D(e,t)},J=y.a.getComponent("Component"),q=y.a.dom,F={},A=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,Object.assign(F,n)))}return f()(t,e),s()(t,[{key:"createEl",value:function(){this.nonIconControl=!0;var e=k()(u()(t.prototype),"createEl",this).call(this,"div",{className:"vjs-control vjs-hlsjs-lr-rec-status-bar",innerHTML:'<span class="vjs-hlsjs-lr-rec-indicator"><i class="material-icons md-10">fiber_manual_record</i>REC</span>'});return this.recordedEl_=q.createEl("span",{className:"vjs-hlsjs-lr-recorded",innerText:"--:--:--"},{"aria-live":"off",role:"presentation"}),e.appendChild(this.recordedEl_),e.appendChild(q.createEl("span",{className:"vjs-hlsjs-lr-divider",innerText:"/"},{"aria-live":"off",role:"presentation"})),this.recordLeftEl_=q.createEl("span",{className:"vjs-hlsjs-lr-record-left",innerText:"--:--:--"},{"aria-live":"off",role:"presentation"}),e.appendChild(this.recordLeftEl_),this.updateRecordTime(0),this.updateRecordLeftTime(3600),e}},{key:"updateRecordTime",value:function(e){this.recordedEl_&&(this.recordedEl_.innerText=I(e))}},{key:"updateRecordLeftTime",value:function(e){this.recordLeftEl_&&(this.recordLeftEl_.innerText=I(e))}},{key:"dispose",value:function(){this.recordedEl_=null,this.recordLeftEl_=null,k()(u()(t.prototype),"dispose",this).call(this)}}]),t}(J),X=n(9),U=n.n(X),Q=function(e){return e+"-"+Date.now()},G=y.a.getComponent("Component"),V=y.a.dom,$=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,n))}return f()(t,e),s()(t,[{key:"getQualityLevels",value:function(){var e=this.player().hlsJSLiveRecord().getHlsJs(),t=e.levels||[],n=e.currentLevel||0;return t.map((function(e,t){return{label:e.height+"p",value:t,selected:t===n}})).sort((function(e,t){return"object"!==U()(e)||"object"!==U()(t)?-1:e.value<t.value?-1:e.value>t.value?1:0}))}},{key:"createEl",value:function(){var e=k()(u()(t.prototype),"createEl",this).call(this,"div",{className:"vjs-hlsjs-tab-realtime-record"});return this.options().realtimeRecord.allowed?(e.appendChild(this.renderHead()),e.appendChild(this.renderQualitySelector()),e.appendChild(this.renderButton()),e.appendChild(this.renderFooter()),e):e.appendChild(this.renderNotAllowedContent())}},{key:"renderHead",value:function(){var e=this,t=(this.options().realtimeRecord.modalHeaderContent||function(){return'<p>Real-time recording allows you to record a fragment of the program you are watching. Recording will be done until the recording stops, the recording time limit is exceeded or the tab is closed.To start recording, select your preferred quality and click <strong>"start recording"</strong>.</p><p>Your current recording time limit is '+e.options().maxRecordMinutes+" min.</p>"})();return V.createEl("div",{innerHTML:t})}},{key:"renderFooter",value:function(){var e=(this.options().realtimeRecord.modalFooterContent||function(){return""})();return V.createEl("div",{innerHTML:e})}},{key:"renderQualitySelector",value:function(){var e=this,t=V.createEl("div",{className:"vjs-hlsjs-tab-quality-select vjs-hlsjs-form-group"}),n=Q("vjs-hls-quality-select");return t.appendChild(V.createEl("label",{for:n,innerText:"Quality",className:"vjs-hlsjs-form-label"})),this.qualitySelect=V.createEl("select",{id:n,className:"vjs-hlsjs-form-input"}),this.getQualityLevels().forEach((function(t){e.qualitySelect.appendChild(V.createEl("option",{value:t.value,text:t.label,selected:t.selected})),t.selected&&(e.qualitySelect.value=t.value)})),t.appendChild(this.qualitySelect),t}},{key:"renderButton",value:function(){var e=V.createEl("div",{className:"vjs-hlsjs-form-group"});return e.appendChild(V.createEl("button",{className:"vjs-hlsjs-button vjs-hlsjs-start-record",innerText:"Start Recording",onclick:this.handleStartRecording.bind(this)})),e}},{key:"renderNotAllowedContent",value:function(){if(this.renderedEl_)return this.renderedEl_;var e=(this.options().realtimeRecord.notAllowedContent||function(){return"<h2>Recording not allowed</h2>"})();return this.renderedEl_=V.createEl("div",{className:"",innerHTML:e}),this.renderedEl_}},{key:"handleStartRecording",value:function(){this.player().hlsJSLiveRecord().startRealtimeRecord(this.qualitySelect.value)}}]),t}(G),Y=y.a.getComponent("Component"),z=(y.a.dom,function(e){function t(e,n){return r()(this,t),console.group("BackgroundRecordTabHlsJs.js:20 - constructor"),console.log(e),console.groupEnd(),a()(this,u()(t).call(this,e,n))}return f()(t,e),s()(t,[{key:"createEl",value:function(){return k()(u()(t.prototype),"createEl",this).call(this,"div",{className:"vjs-hlsjs-tab-background-record",innerHTML:"<p>vjs-hlsjs-tab-background-record</p>"})}}]),t}(Y)),W=y.a.getComponent("Component"),K=y.a.dom,Z=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,n))}return f()(t,e),s()(t,[{key:"createEl",value:function(){var e=k()(u()(t.prototype),"createEl",this).call(this,"div",{className:"vjs-hlsjs-vertical-tabs"});return e.appendChild(this.renderNav()),e.appendChild(this.renderBody()),e}},{key:"renderNav",value:function(){var e=this,t=K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-nav"});return t.appendChild(K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-nav-elem active",innerHTML:"Realtime",onclick:function(){e.handleClick(0)}})),t.appendChild(K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-nav-elem",innerHTML:"Background",onclick:function(){e.handleClick(1)}})),t}},{key:"renderBody",value:function(){var e=K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-body"});this.realtimeRecord=new $(this.player_,this.options());var t=K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-elem active"});t.appendChild(this.realtimeRecord.el_),e.appendChild(t),this.backgroundRecord=new z(this.player_,this.options());var n=K.createEl("div",{className:"vjs-hlsjs-vertical-tabs-elem"});return n.appendChild(this.backgroundRecord.el_),e.appendChild(n),e}},{key:"handleClick",value:function(e){this.$$(".vjs-hlsjs-vertical-tabs-nav-elem").forEach((function(t,n){e===n?K.addClass(t,"active"):K.removeClass(t,"active")})),this.$$(".vjs-hlsjs-vertical-tabs-elem").forEach((function(t,n){e===n?K.addClass(t,"active"):K.removeClass(t,"active")}))}}]),t}(W),ee=y.a.getComponent("ModalDialog"),te=y.a.dom,ne=function(e){function t(e,n){return r()(this,t),a()(this,u()(t).call(this,e,n))}return f()(t,e),s()(t,[{key:"buildCSSClass",value:function(){return"vjs-hlsjs-lr-rec-settings ".concat(k()(u()(t.prototype),"buildCSSClass",this).call(this))}},{key:"content",value:function(){return this.options().allowed?(this.tabsComponent=new Z(this.player_,this.options()),this.tabsComponent.el_):this.renderNotAllowedContent()}},{key:"renderNotAllowedContent",value:function(){if(this.renderedEl_)return this.renderedEl_;var e=(this.options().notAllowedContent||function(){return"<h2>Recording not allowed</h2>"})();return this.renderedEl_=te.createEl("div",{className:"",innerHTML:e}),this.renderedEl_}}]),t}(ee);ne.prototype.options_=Object.assign({},ee.prototype.options_,{pauseOnOpen:!1,fillAlways:!1,temporary:!0,uncloseable:!1}),y.a.registerComponent("RecSettingsModalHlsJs",ne);var oe=ne,re=function e(t){var n=this;r()(this,e),m()(this,"init",(function(){var e=n.plugin.player.getChild("ControlBar"),t=e.addChild("Component",{},2);t.addClass("vjs-hlsjs-controls-holder"),n.removeDefaultControls(),n.listOfControlsHiddenOnRec=n.plugin.options.listOfControlsHiddenOnRec.map((function(t){return e.children().filter((function(e){return e.hasClass(t)}))[0]})).filter((function(e){return!!e})),n.cachedButtonComponent=t.addChild("CachedButtonHlsJs",{clickHandler:n.activeLiveMode},1),n.cachedButtonComponent.hide(),n.liveButtonComponent=e.addChild("LiveButtonHlsJs",{clickHandler:n.activateProgressMode},2),n.liveButtonComponent.hide(),n.recButtonComponent=t.addChild("RecButtonHlsJs",{clickHandler:n.showRecordSettings},1),n.recButtonComponent.hide(),n.stopButtonComponent=e.addChild("StopButtonHlsJs",{clickHandler:n.plugin.stopRealtimeRecord},1),n.stopButtonComponent.hide(),n.recStatusBarComponent=t.addChild("RecStatusBarHlsJs",1),n.recStatusBarComponent.hide(),n.progressControlComponent=t.addChild("ProgressControlHlsJs",{},2),n.progressControlComponent.hide(),n.activeLiveMode()})),m()(this,"removeDefaultControls",(function(){var e=n.plugin.player.getChild("ControlBar");e.removeChild("ProgressControl"),e.removeChild("SeekToLive"),e.removeChild("LiveDisplay")})),m()(this,"activeLiveMode",(function(){try{n.showOtherControl(),n.showLiveControl(),n.hideProgressControl(),n.hideRecControl(),n.plugin.player.liveTracker.seekToLiveEdge()}catch(e){n.plugin.player.log.warn(e.message)}})),m()(this,"activateProgressMode",(function(){n.plugin.state.recordInProcess||(n.showOtherControl(),n.showProgressControl(),n.hideLiveControl(),n.hideRecControl())})),m()(this,"showRecordSettings",(function(){n.recSettingsModalComponent=new oe(n.plugin.player,n.plugin.options),n.plugin.player.addChild(n.recSettingsModalComponent),n.recSettingsModalComponent.open()})),m()(this,"activateRecordMode",(function(){n.recSettingsModalComponent.close(),n.hideProgressControl(),n.hideLiveControl(),n.hideOtherControl(),n.showRecControl()})),m()(this,"showRecControl",(function(){var e=60*n.plugin.options.maxRecordMinutes;n.plugin.player.addClass("vjs-hlsjs-record-started"),n.recStatusBarComponent.updateRecordLeftTime(e),n.recStatusBarComponent.updateRecordTime(0);var t=1;n.recordUpdateInterval=setInterval((function(){t>=e&&n.plugin.stopRealtimeRecord(),n.recStatusBarComponent.updateRecordTime(t++)}),1e3),n.stopButtonComponent.show(),n.recStatusBarComponent.show()})),m()(this,"hideRecControl",(function(){n.plugin.player.removeClass("vjs-hlsjs-record-started"),clearInterval(n.recordUpdateInterval),n.stopButtonComponent.hide(),n.recStatusBarComponent.hide()})),m()(this,"showProgressControl",(function(){n.progressControlComponent.show(),n.cachedButtonComponent.show()})),m()(this,"hideProgressControl",(function(){n.progressControlComponent.hide(),n.cachedButtonComponent.hide()})),m()(this,"hideOtherControl",(function(){n.listOfControlsHiddenOnRec.forEach((function(e){return e.addClass("vjs-hlsjs-lr-hidden")}))})),m()(this,"showOtherControl",(function(){n.listOfControlsHiddenOnRec.forEach((function(e){return e.removeClass("vjs-hlsjs-lr-hidden")}))})),m()(this,"showLiveControl",(function(){n.liveButtonComponent.show(),n.recButtonComponent.show()})),m()(this,"hideLiveControl",(function(){n.liveButtonComponent.hide(),n.recButtonComponent.hide()})),this.plugin=t,this.recButtonComponent=null,this.stopButtonComponent=null,this.recStatusBarComponent=null,this.progressControlComponent=null,this.liveButtonComponent=null,this.cachedButtonComponent=null,this.recSettingsModalComponent=null,this.listOfControlsHiddenOnRec=[]};function ie(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}var se=function(){function e(t){r()(this,e),this.plugin=t,this.db=null}return s()(e,[{key:"init",value:function(){var e=this,t=indexedDB.open(this.plugin.options.storageDbName,1);t.onupgradeneeded=function(){e.db=t.result,e.db.createObjectStore(e.plugin.options.storagePlaylistsName,{keyPath:"id"}),e.db.createObjectStore(e.plugin.options.storageFragmentsName,{keyPath:"uuid"}).createIndex("playlistId","playlistId",{unique:!1})},t.onsuccess=function(){e.db=t.result}}},{key:"checkRequirements",value:function(){return"indexedDB"in window}},{key:"saveFragment",value:function(e,t,n){var o=this;return new Promise((function(r){if(null!==o.db){var i=o.db.transaction(o.plugin.options.storageFragmentsName,"readwrite").objectStore(o.plugin.options.storageFragmentsName).add(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ie(Object(n),!0).forEach((function(t){m()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ie(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},e,{payload:t,stats:n}));i.onsuccess=function(){},i.onerror=function(){},r(!0)}else r(!0)}))}},{key:"savePlaylist",value:function(e){var t=this;return new Promise((function(n){if(null!==t.db){var o=t.db.transaction(t.plugin.options.storagePlaylistsName,"readwrite").objectStore(t.plugin.options.storagePlaylistsName).put(e);o.onsuccess=function(){},o.onerror=function(){},n(!0)}else n(!0)}))}}]),e}(),le=function e(t){r()(this,e),this.duration=t.duration||0,this.url=t.url||"",this.playlistId=t.playlistId||"tmp",this.uuid=Q(this.playlistId+"-"+this.url.split("/").pop()),this.saved=t.saved||!1},ae=function(){function e(t){r()(this,e),this.id=t.id||"",this.width=t.width||384,this.height=t.height||384,this.fragments=t.fragments||[],this.targetduration=t.targetduration||0,this.mime=t.mime||{},this.createdAt=t.createdAt||Date.now(),this.updatedAt=t.updatedAt||null,this.recFinished=t.recFinished||!1}return s()(e,[{key:"addFragment",value:function(e,t){var n=new le({duration:e,url:t});return this.fragments.push(n),n}},{key:"fragmentSaved",value:function(e){this.fragments=this.fragments.map((function(t){return t.uuid===e.uuid&&(t.saved=!0),t})),this.updatedAt=Date.now()}},{key:"finished",value:function(){this.updatedAt=Date.now(),this.recFinished=!0}},{key:"toString",value:function(){return"#EXTM3U\n#EXT-X-VERSION:4\n#EXT-X-TARGETDURATION:"+this.targetduration+"\n#EXT-X-MEDIA-SEQUENCE:0\n"+this.fragments.filter((function(e){return e.saved})).map((function(e){return t=e.duration,n=e.uuid,"#EXTINF:"+t+",\n"+n+"\n";var t,n})).join("")+"#EXT-X-ENDLIST\n"}}]),e}(),ce=function(e){return e<10?"0"+e:e},ue=function(e,t){return[e.getFullYear(),ce(e.getMonth()+1),ce(e.getDate()),ce(e.getHours()),ce(e.getMinutes()),ce(e.getSeconds())].join(t)},de=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"-";return ue(new Date,e)},he=window,pe=he.performance,fe=he.XMLHttpRequest,ve=function(){function e(t){r()(this,e),t&&t.xhrSetup&&(this.xhrSetup=t.xhrSetup)}return s()(e,[{key:"destroy",value:function(){this.abort(),this.loader=null}},{key:"abort",value:function(){var e=this.loader;e&&4!==e.readyState&&(this.stats.aborted=!0,e.abort()),window.clearTimeout(this.requestTimeout),this.requestTimeout=null,window.clearTimeout(this.retryTimeout),this.retryTimeout=null}},{key:"load",value:function(e,t,n){this.context=e,this.config=t,this.callbacks=n,this.stats={trequest:pe.now(),retry:0},this.retryDelay=t.retryDelay,this.loadInternal()}},{key:"loadInternal",value:function(){var e,t=this.context;e=this.loader=new fe;var n=this.stats;n.tfirst=0,n.loaded=0;var o=this.xhrSetup;try{if(o)try{o(e,t.url)}catch(n){e.open("GET",t.url,!0),o(e,t.url)}e.readyState||e.open("GET",t.url,!0)}catch(n){return void this.callbacks.onError({code:e.status,text:n.message},t,e)}t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),this.config.timeout),e.send()}},{key:"readystatechange",value:function(e){var t=e.currentTarget,n=t.readyState,o=this.stats,r=this.context,i=this.config;if(!o.aborted&&n>=2)if(window.clearTimeout(this.requestTimeout),0===o.tfirst&&(o.tfirst=Math.max(pe.now(),o.trequest)),4===n){var s=t.status;if(s>=200&&s<300){var l,a;o.tload=Math.max(o.tfirst,pe.now()),a="arraybuffer"===r.responseType?(l=t.response).byteLength:(l=t.responseText).length,o.loaded=o.total=a;var c={url:t.responseURL,data:l};this.callbacks.onSuccess(c,o,r,t)}else o.retry>=i.maxRetry||s>=400&&s<499?this.callbacks.onError({code:s,text:t.statusText},r,t):(this.destroy(),this.retryTimeout=window.setTimeout(this.loadInternal.bind(this),this.retryDelay),this.retryDelay=Math.min(2*this.retryDelay,i.maxRetryDelay),o.retry++)}else this.requestTimeout=window.setTimeout(this.loadtimeout.bind(this),i.timeout)}},{key:"loadtimeout",value:function(){this.callbacks.onTimeout(this.stats,this.context,null)}},{key:"loadprogress",value:function(e){var t=e.currentTarget,n=this.stats;n.loaded=e.loaded,e.lengthComputable&&(n.total=e.total);var o=this.callbacks.onProgress;o&&o(n,this.context,null,t)}}]),e}(),me=window.Hls,ge=function(){return new Promise((function(e){e({})}))},ye=function(){function e(t){var n=this;r()(this,e),m()(this,"fragmentLoaded",(function(e,t,o){arguments.length>3&&void 0!==arguments[3]&&arguments[3];o.loader.destroy(),o.loader=null,n.plugin.storageController.saveFragment(o.frag,e.data,t).then((function(){n.playlist.fragmentSaved(o.frag),n.plugin.storageController.savePlaylist(n.playlist)}))})),m()(this,"hlsFragmentLoaded",(function(e,t){n.recordStarted&&n.saveFragment(t.frag)})),this.plugin=t,this.manifestListener=null,this.levelListener=null,this.fragmentListener=null,this.recordStarted=!1,this.playlist=null}return s()(e,[{key:"init",value:function(){var e=this.plugin.getHlsJs();this.fragmentListener=e.on(me.Events.FRAG_LOADED,this.hlsFragmentLoaded)}},{key:"startRecord",value:function(){this.playlist=null,this.recordStarted=!0}},{key:"stopRecord",value:function(){this.recordStarted=!1,this.playlist&&(this.playlist.finished(),this.plugin.storageController.savePlaylist(this.playlist))}},{key:"saveFragment",value:function(e){if(null===this.playlist&&this.initPlaylist(e.level),null!==this.playlist){var t=new ve,n=e.url,o={url:n,frag:this.playlist.addFragment(e.duration,n),responseType:"arraybuffer",progressData:!1,loader:t},r={onSuccess:this.fragmentLoaded};t.load(o,{timeout:60,maxRetry:0,retryDelay:0,maxRetryDelay:3},r)}}},{key:"initPlaylist",value:function(e){var t=this,n=this.plugin.getHlsJs().levels[e],o=(this.plugin.options.realtimeRecord.getRecordMime||ge)();n&&(this.playlist=new ae({id:"record-"+de(),width:n.width,height:n.height,targetduration:n.details.targetduration}),o.then((function(e){t.playlist.mime=e,t.plugin.storageController.savePlaylist(t.playlist)})))}}]),e}(),Ce=y.a.getPlugin("plugin"),be={listOfControlsHiddenOnRec:["vjs-play-control","vjs-quality-selector"],storageDbName:"vjs-hlsjs-lr",storagePlaylistsName:"playlists",storageFragmentsName:"fragments",maxRecordMinutes:60,allowed:!0,notAllowedContent:null,realtimeRecord:{allowed:!0,modalHeaderContent:null,modalFooterContent:null,notAllowedContent:null,getRecordMime:null}},je=function(e){function t(e,n){var o;return r()(this,t),o=a()(this,u()(t).call(this,e,n)),m()(h()(o),"init",(function(){o.state.init||(o.setState({init:!0}),o.checkRequirements()?(o.player.addClass("vjs-hls-live-record"),o.player.on("pause",o.viewController.activateProgressMode),o.viewController.init(),o.storageController.init(),o.realtimeRecordController.init()):y.a.log.warn("HlsJSLiveRecordPlugin: cannot be initialized because one or more of the requirements are not met."))})),m()(h()(o),"checkRequirements",(function(){return o.getHlsJs()?!!o.storageController.checkRequirements()||(y.a.log.warn("HlsJSLiveRecordPlugin: This browser doesn't support IndexedDB."),!1):(y.a.log.warn("HlsJSLiveRecordPlugin: HLS.JS plugin not found."),!1)})),m()(h()(o),"getHlsJs",(function(){return o.player.tech({IWillUseThisInPlugin:!0}).sourceHandler_.hls})),m()(h()(o),"stopRealtimeRecord",(function(){o.realtimeRecordController.stopRecord(),o.viewController.activeLiveMode(),o.setState({recordInProcess:!1}),o.getHlsJs().currentLevel=-1})),o.options=y.a.mergeOptions(be,n),o.storageController=new se(h()(o)),o.viewController=new re(h()(o)),o.realtimeRecordController=new ye(h()(o)),e.on("playing",(function(){o.init()})),o}return f()(t,e),s()(t,[{key:"startRealtimeRecord",value:function(e){this.setState({recordInProcess:!0}),this.getHlsJs().currentLevel=1*e,this.viewController.activateRecordMode(),this.realtimeRecordController.startRecord()}},{key:"handleStateChanged",value:function(e){}}]),t}(Ce);je.VERSION=C.a,je.defaultState={recordAllowed:!0,recordInProcess:!1,init:!1},y.a.registerPlugin("hlsJSLiveRecord",je),y.a.registerComponent("ProgressControlHlsJs",j),y.a.registerComponent("LiveButtonHlsJs",S),y.a.registerComponent("CachedButtonHlsJs",x),y.a.registerComponent("RecButtonHlsJs",P),y.a.registerComponent("StopButtonHlsJs",M),y.a.registerComponent("RecStatusBarHlsJs",A)}])}));
//# sourceMappingURL=videojs-hlsjs-live-record.min.js.map